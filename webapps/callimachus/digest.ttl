@prefix xsd:<http://www.w3.org/2001/XMLSchema#>.
@prefix rdf:<http://www.w3.org/1999/02/22-rdf-syntax-ns#>.
@prefix rdfs:<http://www.w3.org/2000/01/rdf-schema#>.
@prefix owl:<http://www.w3.org/2002/07/owl#>.
@prefix msg:<http://www.openrdf.org/rdf/2011/messaging#>.
@prefix calli:<http://callimachusproject.org/rdf/2009/framework#>.
@prefix :<#>.

<> a <SchemaGraph>.

################################
# Realm
################################

<DigestManager> a <Creatable>, owl:Class;
    rdfs:subClassOf <Viewable>, <Editable>, calli:DigestManager;
    rdfs:isDefinedBy </callimachus>;
    calli:author </group/admin>;
    calli:view <digest-view.xhtml>;
    calli:edit <digest-edit.xhtml>;
    calli:create <digest-create.xhtml>.

################################
# login
################################

# Redirection to the authorized user
# Used to login
:GetLoginPage rdfs:subClassOf msg:Message;
    rdfs:subClassOf [owl:onProperty msg:target; owl:allValuesFrom <DigestManager>];
    rdfs:subClassOf [owl:onProperty msg:literal; owl:allValuesFrom xsd:string];
    calli:method "GET";
    calli:query "login";
    calli:realm </>;
    calli:expect "302-found";
    calli:type "text/uri-list";
    calli:header "cache-control:max-age:3600";
    calli:script """
        return this.findCredential(cookie).toString(); //# login Deprecated
    """.

:cookie a owl:DatatypeProperty;
    rdfs:domain :GetLoginPage;
    rdfs:range xsd:string;
    calli:header "Authorization", "Cookie".

:query a owl:DatatypeProperty, owl:FunctionalProperty;
    rdfs:domain :GetLoginPage;
    rdfs:range xsd:string;
    calli:query "*".

# anybody with credentials can login and is welcome
:AuthorizeLoginPage owl:intersectionOf (calli:IsAuthorized
        [owl:onProperty msg:target; owl:allValuesFrom <DigestManager>]);
    msg:sparql  """
        PREFIX calli:<http://callimachusproject.org/rdf/2009/framework#>
        ASK {
            $this calli:authNamespace [calli:hasComponent $credential]
            FILTER ($method = "GET" || $method = "HEAD")
            FILTER ($query = "login")
        }
    """.

################################
# logout Deprecated
################################

# Prompts the browser to login using bogus credentials (to forget legitimate onces)
# Available to user when logged in
:GetLogout  rdfs:subClassOf msg:Message;
    rdfs:subClassOf [owl:onProperty msg:target; owl:allValuesFrom <DigestManager>];
    rdfs:subClassOf [owl:onProperty msg:object; owl:allValuesFrom <java:org.apache.http.HttpResponse>];
    calli:method "GET";
    calli:query "logout";
    calli:type "message/x-response";
    calli:imports <java:org.apache.http.ProtocolVersion>;
    calli:imports <java:org.apache.http.message.BasicHttpResponse>;
    calli:script """
        var ver = new ProtocolVersion("HTTP", 1, 1);
        if (authorization && authorization.indexOf('username="logout"') > 0) {
            //# bogus credentials received
            var resp = new BasicHttpResponse(ver, 303, "See Other");
            resp.setHeader("Location", "/");
            return resp;
        }
        //# the browser must send invalid credentials to logout
        var resp = new BasicHttpResponse(ver, 401, "Unauthorized");
        var hd = 'Digest realm="' + this.calliAuthName + '", domain="'
            + this.protectionDomain() + '", nonce="logout", algorithm="MD5", qop="auth"';
        resp.setHeader('WWW-Authenticate', hd);
        return resp;
    """.

:authorization a owl:FunctionalProperty, owl:DatatypeProperty;
    rdfs:domain :GetLogout;
    rdfs:range xsd:string;
    calli:header "Authorization".

################################
# User forgot password
################################

# Linked from request password email
:GetForgotPasswordPage rdfs:subClassOf msg:Message;
    rdfs:subClassOf [owl:onProperty msg:target; owl:allValuesFrom <DigestManager>];
    rdfs:subClassOf [owl:onProperty msg:literal; owl:allValuesFrom xsd:string];
    rdfs:subClassOf [owl:onProperty :forgot_password_xhtml; owl:hasValue <pages/forgot-password.xhtml>];
    calli:method "GET";
    calli:query "forgotpassword";
    calli:type "text/html";
    calli:header "cache-control:no-store";
    calli:script """
        return forgot_password_xhtml.Construct(this, 'forgotpassword');
    """.

:forgot_password_xhtml a owl:FunctionalProperty, owl:ObjectProperty;
    rdfs:domain :GetForgotPasswordPage.

# Sends request for password reset emails
# Submitted by form in the unauthorized page
:PostForgotPassword rdfs:subClassOf msg:Message;
    rdfs:subClassOf [owl:onProperty msg:target; owl:allValuesFrom <DigestManager>];
    rdfs:subClassOf [owl:onProperty msg:object; owl:allValuesFrom owl:Nothing];
    rdfs:subClassOf [owl:onProperty :mail_request_password_xhtml; owl:hasValue <pages/mail-request-password.xhtml>];
    calli:method "POST";
    calli:query "forgotpassword";
    calli:imports <java:org.callimachusproject.server.exceptions.BadRequest>;
    calli:imports <java:org.apache.commons.codec.digest.DigestUtils>;
    calli:imports <java:java.io.CharArrayWriter>;
    calli:imports <java:java.util.Random>;
    calli:imports <java:java.lang.Integer>;
    calli:imports <java:java.lang.System>;
    calli:script """
        if (!formEmail)
            throw new BadRequest("Missing Email");
        var iter = this.FindUsersByEmail(formEmail).iterator();
        if (!iter.hasNext()) {
            println("No users with email " + formEmail + " found");
        }
        while (iter.hasNext()) {
            var user = iter.next();
            var ha1 = DigestUtils.md5Hex(user.calliEncoded);
            var nonce = Integer.toHexString(new Random(System.nanoTime()).nextInt());
            var ha2 = DigestUtils.md5Hex(user.toString());
            var token = DigestUtils.md5Hex(ha1 + ":" + nonce + ":" + ha2);
            var qs = "?resetpassword&amp;nonce=" + nonce + "&amp;token=" + token + "&amp;username=" + user.calliName;
            var body = mail_request_password_xhtml.Construct(user);
            body = body.replace(/\\?resetpassword/g, qs);
            user.sendMessage(body, user.rdfsLabel.iterator().next() + " <" + formEmail + ">");
        }
        java.lang.Thread.sleep(new java.util.Random().nextInt() % 2000 + 2000);
    """.

:formEmail a owl:DatatypeProperty, owl:FunctionalProperty;
    rdfs:domain :PostForgotPassword;
    rdfs:range xsd:string;
    calli:type "text/plain".

:mail_request_password_xhtml a owl:FunctionalProperty, owl:ObjectProperty;
    rdfs:domain :PostForgotPassword.

# Looks up user by email address
# Used to request password reset
:FindUsersByEmail rdfs:subClassOf msg:Message;
    rdfs:subClassOf [owl:onProperty msg:target; owl:allValuesFrom <DigestManager>];
    rdfs:subClassOf [owl:onProperty msg:objectSet; owl:allValuesFrom calli:User];
    msg:sparql  """
        PREFIX calli:<http://callimachusproject.org/rdf/2009/framework#>
        SELECT REDUCED ?user
        WHERE {
            $this calli:authNamespace [calli:hasComponent ?user] .
            ?user calli:email $email .
        }
    """.

:email a owl:DatatypeProperty, owl:FunctionalProperty;
    rdfs:domain :FindUsersByEmail;
    rdfs:range xsd:string.

################################
# User reset password
################################

# Linked from request password email
:GetResetPassword rdfs:subClassOf msg:Message;
    rdfs:subClassOf [owl:onProperty msg:target; owl:allValuesFrom <DigestManager>];
    rdfs:subClassOf [owl:onProperty msg:literal; owl:allValuesFrom xsd:string];
    rdfs:subClassOf [owl:onProperty :reset_password_xhtml; owl:hasValue <pages/reset-password.xhtml>];
    calli:method "GET";
    calli:query "resetpassword";
    calli:type "text/html";
    calli:header "cache-control:no-store";
    calli:imports <java:org.apache.commons.codec.digest.DigestUtils>;
    calli:imports <java:org.callimachusproject.server.exceptions.BadRequest>;
    calli:script """
        if (!nonce || !token || !username)
            throw new BadRequest("Missing nonce and/or token and/or username");
        var user = this.objectConnection.getObject(this.calliAuthNamespace + username);
        var ha1 = DigestUtils.md5Hex(user.calliEncoded);
        var ha2 = DigestUtils.md5Hex(user.toString());
        var hex = DigestUtils.md5Hex(ha1 + ":" + nonce + ":" + ha2);
        if (token != hex)
            throw new BadRequest("Request is No Longer Valid");
        return reset_password_xhtml.Construct(user, 'resetpassword');
    """.

:nonce a owl:FunctionalProperty, owl:DatatypeProperty;
    rdfs:domain :GetResetPassword;
    rdfs:range xsd:string;
    calli:query "nonce".

:token a owl:FunctionalProperty, owl:DatatypeProperty;
    rdfs:domain :GetResetPassword;
    rdfs:range xsd:string;
    calli:query "token".

:username a owl:FunctionalProperty, owl:DatatypeProperty;
    rdfs:domain :GetResetPassword;
    rdfs:range xsd:string;
    calli:query "username".

:reset_password_xhtml a owl:FunctionalProperty, owl:ObjectProperty;
    rdfs:domain :GetResetPassword.

# Confirms token and resets their password
:PostResetPassword rdfs:subClassOf msg:Message;
    rdfs:subClassOf [owl:onProperty msg:target; owl:allValuesFrom <DigestManager>];
    rdfs:subClassOf [owl:onProperty msg:object; owl:allValuesFrom owl:Nothing];
    rdfs:subClassOf [owl:onProperty :mail_password_xhtml; owl:hasValue <pages/mail-password.xhtml>];
    calli:method "POST";
    calli:query "resetpassword";
    calli:header "cache-control:no-store";
    calli:imports <java:org.apache.commons.codec.digest.DigestUtils>;
    calli:imports <java:org.callimachusproject.server.exceptions.BadRequest>;
    calli:imports <java:java.io.CharArrayWriter>;
    calli:imports <java:java.util.Random>;
    calli:imports <java:java.lang.Integer>;
    calli:script """
        if (!resetForm.get('nonce') || !resetForm.get("token") || !resetForm.get("username"))
            throw new BadRequest("Missing nonce and/or token and/or username");
        var user = this.objectConnection.getObject(this.calliAuthNamespace + resetForm.get('username')[0]);
        var ha1 = DigestUtils.md5Hex(user.calliEncoded);
        var nonce = resetForm.get('nonce')[0];
        var ha2 = DigestUtils.md5Hex(user.toString());
        var token = DigestUtils.md5Hex(ha1 + ":" + nonce + ":" + ha2);
        if (token != resetForm.get("token")[0])
            throw new BadRequest("Request is No Longer Valid");
        var password = this.generatePassword();
        var decoded = user.calliName + ":" + this.calliAuthName + ":" + password;
        user.calliAlgorithm = "MD5";
        user.calliEncoded = DigestUtils.md5(new java.lang.String(decoded).getBytes("UTF-8"));
        var body = mail_password_xhtml.Construct(user);
        body = body.replace(/@@USERNAME@@/g, user.calliName);
        body = body.replace(/@@PASSWORD@@/g, password);
        user.sendMessage(body, user.rdfsLabel.iterator().next() + " <" + user.calliEmail + ">");
    """.

:resetForm a owl:ObjectProperty, owl:FunctionalProperty;
    rdfs:domain :PostResetPassword;
    rdfs:range <java:java.util.Map>;
    calli:type "application/x-www-form-urlencoded".

:mail_password_xhtml a owl:ObjectProperty, owl:FunctionalProperty;
    rdfs:domain :PostResetPassword.

