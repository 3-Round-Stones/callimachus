@prefix xsd:<http://www.w3.org/2001/XMLSchema#>.
@prefix rdf:<http://www.w3.org/1999/02/22-rdf-syntax-ns#>.
@prefix rdfs:<http://www.w3.org/2000/01/rdf-schema#>.
@prefix owl:<http://www.w3.org/2002/07/owl#>.
@prefix skos:<http://www.w3.org/2004/02/skos/core#>.
@prefix msg:<http://www.openrdf.org/rdf/2011/messaging#>.
@prefix calli:<http://callimachusproject.org/rdf/2009/framework#>.
@prefix audit:<http://www.openrdf.org/rdf/2009/auditing#>.
@prefix :<#>.

:RecentChanges rdfs:subClassOf msg:Message;
	rdfs:subClassOf [owl:onProperty msg:target; owl:hasValue <../changes>];
	rdfs:subClassOf [owl:onProperty msg:object; owl:allValuesFrom <java:java.io.InputStream>];
	msg:method "GET";
	msg:type "application/sparql-results+xml";
	msg:header "cache-control:no-validate,max-age=60";
	msg:transform :TransformRecentChanges;
	msg:sparql  """
		SELECT DISTINCT ?label ?note ?icon ?url ?revision ?modified ?user ?name
		WHERE {
			?revision a audit:RecentTransaction; audit:contributor ?user; audit:committedOn ?modified
			{
				GRAPH ?revision {
					?url ?p ?o
					FILTER (?p != audit:contained)
					FILTER (?p != audit:revision)
					FILTER (?p != calli:soundex)
				}
			} UNION {
				?revision audit:contained [rdf:subject ?url; rdf:predicate ?p]
				FILTER (?p != audit:revision)
			}
			?user rdfs:label ?name
			FILTER (?url != ?revision)
			FILTER (?url != ?user)
			FILTER (isIRI(?url))
			OPTIONAL { ?url skos:prefLabel ?label }
			OPTIONAL { ?url rdfs:label ?label }
			OPTIONAL { ?url a [calli:icon ?icon] }
			OPTIONAL {
				{
					GRAPH ?revision { ?url skos:changeNote ?note }
				} UNION {
					?revision audit:contained [rdf:subject ?url; rdf:predicate skos:changeNote; rdf:object ?note]
				}
			}
		}
		ORDER BY desc(?modified) ?url
		LIMIT 100
	""".

:TransformRecentChanges rdfs:subClassOf msg:Message;
	rdfs:subClassOf [owl:onProperty msg:object; owl:allValuesFrom <java:java.io.InputStream>];
	msg:type "application/xml";
	msg:transform <../layout.ttl#TransformLayout>;
	msg:xslt <recent-changes.xsl>.

:inputStream a owl:ObjectProperty; a owl:FunctionalProperty;
	rdfs:domain :TransformRecentChanges;
	rdfs:range <java:java.io.InputStream>.

