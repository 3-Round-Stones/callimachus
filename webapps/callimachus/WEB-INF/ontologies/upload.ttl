# 
#    Portions Copyright (c) 2009-10 Zepheira LLC, Some Rights Reserved
#    Portions Copyright (c) 2010-11 Talis Inc, Some Rights Reserved
# 
#    Licensed under the Apache License, Version 2.0 (the "License");
#    you may not use this file except in compliance with the License.
#    You may obtain a copy of the License at
# 
#        http://www.apache.org/licenses/LICENSE-2.0
# 
#    Unless required by applicable law or agreed to in writing, software
#    distributed under the License is distributed on an "AS IS" BASIS,
#    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#    See the License for the specific language governing permissions and
#    limitations under the License.

@prefix xsd:<http://www.w3.org/2001/XMLSchema#>.
@prefix rdf:<http://www.w3.org/1999/02/22-rdf-syntax-ns#>.
@prefix rdfs:<http://www.w3.org/2000/01/rdf-schema#>.
@prefix owl:<http://www.w3.org/2002/07/owl#>.
@prefix msg:<http://www.openrdf.org/rdf/2011/messaging#>.
@prefix calli:<http://callimachusproject.org/rdf/2009/framework#>.
@prefix :<#>.

:PutContentType rdfs:subClassOf msg:Message.

:contentType a owl:DatatypeProperty; a owl:FunctionalProperty;
	rdfs:domain :PutContentType;
	rdfs:range xsd:string;
	msg:header "Content-Type".

################################
# RDF Named Schema Graph
################################

calli:NamedGraph a owl:Class.
calli:SchemaGraph a owl:Class.

:PutTurtleDocument rdfs:subClassOf :PutContentType;
	rdfs:subClassOf [owl:onProperty msg:objectSet; owl:allValuesFrom owl:Nothing];
	msg:method "PUT";
	msg:query "calliwebapps";
	msg:realm calli:nobody;
	msg:imports <java:org.openrdf.rio>;
	msg:imports calli:NamedGraph;
	msg:imports calli:SchemaGraph;
	msg:imports <java:org.openrdf.repository.util.RDFInserter>;
	msg:script """
		this.calliDeleteWebResource();
		this.objectConnection.addDesignation(this, NamedGraph);

		var type = contentType;
		if (type.indexOf(';') > 0) {
			type = type.substring(0, type.indexOf(';'));
		}
		var dataFormat = RDFFormat.forMIMEType(type);
		var vf = this.objectConnection.getValueFactory();
		var rdfParser = Rio.createParser(dataFormat, vf);

		rdfParser.setVerifyData(true);
		rdfParser.setStopAtFirstError(true);
		rdfParser.setDatatypeHandling(RDFParser.DatatypeHandling.IGNORE);

		var target = this;
		var schema = false;
		var owlns = "http://www.w3.org/2002/07/owl#";
		var rdfsns = "http://www.w3.org/2000/01/rdf-schema#";
		var rdfns = "http://www.w3.org/1999/02/22-rdf-syntax-ns#";
		var msgns = "http://www.openrdf.org/rdf/2011/messaging#";
		var objns = "http://www.openrdf.org/rdf/2009/object#";
		function checkForSchema(st) {
			if (schema)
				return;
			var ns = st.predicate.namespace;
			if (ns == owlns || ns == msgns || ns == objns) {
				schema = true;
			} else if (ns == rdfsns) {
				var local = st.predicate.localName;
				schema = local == "subClassOf" || local == "subPropertyOf"
					|| local == "domain" || local == "range";
			} else if (ns == rdfns && st.predicate.localName == "type") {
				var ons = st.object.namespace;
				var local = st.object.localName;
				schema = ons == owlns && local != "Thing"
					|| ons == rdfsns && local == "Class"
					|| ons == rdfns && local == "Property";
			}
			if (schema) {
				target.objectConnection.addDesignation(target, SchemaGraph);
			}
		}

		var rdfInserter = new RDFInserter(this.objectConnection);
		rdfInserter.enforceContext([this.resource]);
		rdfParser.setRDFHandler(new RDFHandler({
			startRDF: function() { rdfInserter.startRDF(); },
			endRDF: function() { rdfInserter.endRDF(); },
			handleNamespace: function(prefix, uri) { rdfInserter.handleNamespace(prefix, uri); },
			handleComment: function(comment) { rdfInserter.handleComment(comment); },
			handleStatement: function(st) {
				checkForSchema(st);
				rdfInserter.handleStatement(st);
			}
		}));
		rdfParser.parse(turtleStream, this.toString());
	""".

:turtleStream a owl:ObjectProperty; a owl:FunctionalProperty;
	rdfs:domain :PutTurtleDocument;
	rdfs:range <java:java.io.InputStream>;
	msg:type "text/turtle", "application/x-turtle".

################################
# RDF Named Graph
################################

:PutGraphDocument rdfs:subClassOf :PutContentType;
	rdfs:subClassOf [owl:onProperty msg:objectSet; owl:allValuesFrom owl:Nothing];
	msg:method "PUT";
	msg:query "calliwebapps";
	msg:realm calli:nobody;
	msg:imports <java:org.openrdf.rio>;
	msg:imports calli:NamedGraph;
	msg:imports <java:org.openrdf.repository.util.RDFInserter>;
	msg:script """
		this.calliDeleteWebResource();
		this.objectConnection.addDesignation(this, NamedGraph);

		var type = contentType;
		if (type.indexOf(';') > 0) {
			type = type.substring(0, type.indexOf(';'));
		}
		var dataFormat = RDFFormat.forMIMEType(type);
		var vf = this.objectConnection.getValueFactory();
		var rdfParser = Rio.createParser(dataFormat, vf);

		rdfParser.setVerifyData(true);
		rdfParser.setStopAtFirstError(true);
		rdfParser.setDatatypeHandling(RDFParser.DatatypeHandling.IGNORE);

		var rdfInserter = new RDFInserter(this.objectConnection);
		rdfInserter.enforceContext([this.resource]);
		rdfParser.setRDFHandler(rdfInserter);
		rdfParser.parse(rdfStream, this.toString());
	""".

:rdfStream a owl:ObjectProperty; a owl:FunctionalProperty;
	rdfs:domain :PutGraphDocument;
	rdfs:range <java:java.io.InputStream>;
	msg:type "application/rdf+xml".

################################
# Text File
################################

:PutTextDocument rdfs:subClassOf :PutContentType;
	rdfs:subClassOf [owl:onProperty msg:objectSet; owl:allValuesFrom owl:Nothing];
	msg:method "PUT";
	msg:query "calliwebapps";
	msg:realm calli:nobody;
	msg:imports calli:Template;
	msg:script """
		this.calliDeleteWebResource();
		var type = "urn:mimetype:" + contentType;
		if (type.indexOf(';') > 0) {
			type = type.substring(0, type.indexOf(';'));
		}
		this.objectConnection.addDesignation(this, type);
		var read;
		var cbuf = java.lang.reflect.Array.newInstance(java.lang.Character.TYPE, 1024);
		var out = this.openWriter();
		try {
			while ((read = textReader.read(cbuf)) >= 0) {
				out.write(cbuf, 0, read);
			}
		} finally {
			out.close();
		}
	""".

:textReader a owl:ObjectProperty; a owl:FunctionalProperty;
	rdfs:domain :PutTextDocument;
	rdfs:range <java:java.io.Reader>;
	msg:type "text/html", "text/html-sandboxed", "text/cache-manifest",
		"text/css", "text/plain".

################################
# JavaScript File
################################

:PutJavaScriptDocument rdfs:subClassOf :PutContentType;
	rdfs:subClassOf [owl:onProperty msg:objectSet; owl:allValuesFrom owl:Nothing];
	msg:method "PUT";
	msg:query "calliwebapps";
	msg:realm calli:nobody;
	msg:imports calli:Template;
	msg:script """
		this.calliDeleteWebResource();
		var con = this.objectConnection;
		var type = "urn:mimetype:text/javascript";
		con.addDesignation(this, type);
		var read;
		var cbuf = java.lang.reflect.Array.newInstance(java.lang.Character.TYPE, 1024);
		var out = this.openWriter();
		try {
			while ((read = jsReader.read(cbuf)) >= 0) {
				out.write(cbuf, 0, read);
			}
		} finally {
			out.close();
		}
		var bundles = con.getStatements(null, null, this.resource, true, []);
		try {
			while (bundles.hasNext()) {
				var bundle = bundles.next().subject;
				if (bundle.stringValue().contains(":")) {
					con.getObject(bundle).touchRevision();
				}
			}
		} finally {
			bundles.close();
		}
	""".

:jsReader a owl:ObjectProperty; a owl:FunctionalProperty;
	rdfs:domain :PutJavaScriptDocument;
	rdfs:range <java:java.io.Reader>;
	msg:type "text/javascript".

################################
# Binary File
################################

:PutBinaryDocument rdfs:subClassOf :PutContentType;
	rdfs:subClassOf [owl:onProperty msg:objectSet; owl:allValuesFrom owl:Nothing];
	msg:method "PUT";
	msg:query "calliwebapps";
	msg:header "cache-control:cache-range";
	msg:realm calli:nobody;
	msg:script """
		this.calliDeleteWebResource();
		var type = "urn:mimetype:" + contentType;
		if (type.indexOf(';') > 0) {
			type = type.substring(0, type.indexOf(';'));
		}
		this.objectConnection.addDesignation(this, type);
		var read;
		var buf = java.lang.reflect.Array.newInstance(java.lang.Byte.TYPE, 1024);
		var out = this.openOutputStream();
		try {
			while ((read = binaryStream.read(buf)) >= 0) {
				out.write(buf, 0, read);
			}
		} finally {
			out.close();
		}
	""".

:binaryStream a owl:ObjectProperty; a owl:FunctionalProperty;
	rdfs:domain :PutBinaryDocument;
	rdfs:range <java:java.io.InputStream>;
	msg:type "image/png", "image/jpeg", "image/gif", "image/svg+xml", "image/vnd.microsoft.icon", "application/pdf".

################################
# SPARQL File
################################

:PutSparqlDocument rdfs:subClassOf :PutContentType;
	rdfs:subClassOf [owl:onProperty msg:objectSet; owl:allValuesFrom owl:Nothing];
	msg:method "PUT";
	msg:query "calliwebapps";
	msg:header "cache-control:cache-range";
	msg:realm calli:nobody;
	msg:script """
		this.calliDeleteWebResource();
		var type = "urn:mimetype:" + contentType;
		if (type.indexOf(';') > 0) {
			type = type.substring(0, type.indexOf(';'));
		}
		this.objectConnection.addDesignation(this, type);
		var read;
		var buf = java.lang.reflect.Array.newInstance(java.lang.Byte.TYPE, 1024);
		var out = this.openOutputStream();
		try {
			while ((read = sparqlStream.read(buf)) >= 0) {
				out.write(buf, 0, read);
			}
		} finally {
			out.close();
		}
	""".

:sparqlStream a owl:ObjectProperty; a owl:FunctionalProperty;
	rdfs:domain :PutSparqlDocument;
	rdfs:range <java:java.io.InputStream>;
	msg:type "application/sparql-query".

################################
# XSL File
################################

:PutXslDocument rdfs:subClassOf msg:Message;
	rdfs:subClassOf [owl:onProperty msg:objectSet; owl:allValuesFrom owl:Nothing];
	msg:method "PUT";
	msg:query "calliwebapps";
	msg:header "cache-control:cache-range";
	msg:realm calli:nobody;
	msg:imports <java:org.openrdf.http.object.HTTPObjectServer>;
	msg:script """
		this.calliDeleteWebResource();
		this.objectConnection.addDesignation(this, "urn:mimetype:text/xsl");
		var read;
		var buf = java.lang.reflect.Array.newInstance(java.lang.Byte.TYPE, 1024);
		var out = this.openOutputStream();
		try {
			while ((read = xslStream.read(buf)) >= 0) {
				out.write(buf, 0, read);
			}
		} finally {
			out.close();
		}
		HTTPObjectServer.resetAllCache();
	""".

:xslStream a owl:ObjectProperty; a owl:FunctionalProperty;
	rdfs:domain :PutXslDocument;
	rdfs:range <java:java.io.InputStream>;
	msg:type "text/xsl".

################################
# XML File
################################

:PutXmlDocument rdfs:subClassOf msg:Message;
	rdfs:subClassOf [owl:onProperty msg:objectSet; owl:allValuesFrom owl:Nothing];
	msg:method "PUT";
	msg:query "calliwebapps";
	msg:header "cache-control:cache-range";
	msg:realm calli:nobody;
	msg:imports calli:Template;
	msg:imports <java:org.openrdf.http.object.HTTPObjectServer>;
	msg:script """
		this.calliDeleteWebResource();
		this.objectConnection.addDesignation(this, Template);
		this.objectConnection.addDesignation(this, "urn:mimetype:application/xml");
		var read;
		var buf = java.lang.reflect.Array.newInstance(java.lang.Byte.TYPE, 1024);
		var out = this.openOutputStream();
		try {
			while ((read = xmlStream.read(buf)) >= 0) {
				out.write(buf, 0, read);
			}
		} finally {
			out.close();
		}
		HTTPObjectServer.resetAllCache();
	""".

:xmlStream a owl:ObjectProperty; a owl:FunctionalProperty;
	rdfs:domain :PutXmlDocument;
	rdfs:range <java:java.io.InputStream>;
	msg:type "application/xml".

################################
# XHTML File
################################

:PutXhtmlDocument rdfs:subClassOf msg:Message;
	rdfs:subClassOf [owl:onProperty msg:objectSet; owl:allValuesFrom owl:Nothing];
	msg:method "PUT";
	msg:query "calliwebapps";
	msg:header "cache-control:cache-range";
	msg:realm calli:nobody;
	msg:imports calli:Template;
	msg:imports <java:org.openrdf.http.object.HTTPObjectServer>;
	msg:script """
		this.calliDeleteWebResource();
		this.objectConnection.addDesignation(this, Template);
		this.objectConnection.addDesignation(this, "urn:mimetype:application/xhtml+xml");
		var read;
		var buf = java.lang.reflect.Array.newInstance(java.lang.Byte.TYPE, 1024);
		var out = this.openOutputStream();
		try {
			while ((read = xhtmlStream.read(buf)) >= 0) {
				out.write(buf, 0, read);
			}
		} finally {
			out.close();
		}
		HTTPObjectServer.resetAllCache();
	""".

:xhtmlStream a owl:ObjectProperty; a owl:FunctionalProperty;
	rdfs:domain :PutXhtmlDocument;
	rdfs:range <java:java.io.InputStream>;
	msg:type "application/xhtml+xml".

################################
# DELETE
################################

calli:DeleteWebResource rdfs:subClassOf msg:Message;
	rdfs:subClassOf [owl:onProperty msg:objectSet; owl:allValuesFrom owl:Nothing];
	msg:method "DELETE";
	msg:query "calliwebapps";
	msg:realm calli:nobody;
	msg:imports calli:Template;
	msg:imports <java:org.openrdf.model.vocabulary.RDF>;
	msg:imports <java:javax.tools.FileObject>;
	msg:script """
		var con = this.objectConnection;
		var types = con.getStatements(this.resource, RDF.TYPE, null, true, []);
		try {
			while (types.hasNext()) {
				var type = types.next().object.stringValue();
				if (type.indexOf("urn:mimetype:") == 0) {
					con.remove(st, []);
				}
			}
		} finally {
			types.close();
		}
		con.removeDesignation(this, Template);
		con.clear([this.resource]); //# clear graph
		if (this instanceof FileObject) {
			this['delete'](); //# remove document
		}
	""".

