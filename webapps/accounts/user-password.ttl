@prefix xsd:<http://www.w3.org/2001/XMLSchema#>.
@prefix rdf:<http://www.w3.org/1999/02/22-rdf-syntax-ns#>.
@prefix rdfs:<http://www.w3.org/2000/01/rdf-schema#>.
@prefix owl:<http://www.w3.org/2002/07/owl#>.
@prefix msg:<http://www.openrdf.org/rdf/2011/messaging#>.
@prefix calli:<http://callimachusproject.org/rdf/2009/framework#>.
@prefix :<#>.

:GetUserPasswordPage rdfs:subClassOf msg:Message;
	rdfs:subClassOf [owl:onProperty msg:target; owl:allValuesFrom <User>];
	rdfs:subClassOf [owl:onProperty msg:literal; owl:allValuesFrom xsd:string];
	msg:method "GET";
	msg:query "password";
	msg:type "text/html";
	msg:realm </accounts>;
	msg:imports <user-password.xhtml>;
	msg:script """
		return user_password_xhtml.calliConstructHTML(this, "edit");
	""".

:PostUserPassword rdfs:subClassOf msg:Message;
	rdfs:subClassOf [owl:onProperty msg:target; owl:allValuesFrom <User>];
	rdfs:subClassOf [owl:onProperty msg:objectSet; owl:maxCardinality "1"^^xsd:nonNegativeInteger];
	msg:method "POST";
	msg:query "password";
	msg:realm </accounts>;
	msg:expect "201-modified";
	msg:imports </accounts>;
	msg:imports <java:org.openrdf.http.object.exceptions.BadRequest>;
	msg:imports <java:org.apache.commons.codec.binary.Hex>;
	msg:script """
		var credential = accounts.findCredential(authorization);
		//# read form
		var email = form.get("email") ? form.get("email")[0] : null;
		var current = form.get("current") ? form.get("current")[0] : null;
		var password = form.get("password") ? form.get("password")[0] : null;
		if (this == credential) {
			//# check if they know their own password
			if (!current)
				throw new BadRequest("What is your current password?");
			var encoded = Hex.decodeHex(current.toCharArray());
			if (!java.util.Arrays.equals(this.calliEncoded, encoded))
				throw new BadRequest("That is not your current password");
		}
		//# save email
		if (email && email.length()) {
			this.calliEmail = email;
		}
		//# save password
		if (password && password.length()) {
			this.calliEncoded = Hex.decodeHex(password.toCharArray());
		}
		return this;
	""".

:form a owl:ObjectProperty, owl:FunctionalProperty;
	rdfs:domain :PostUserPassword;
	rdfs:range <java:java.util.Map>;
	msg:type "application/x-www-form-urlencoded".

:authorization a owl:DatatypeProperty, owl:FunctionalProperty;
	rdfs:domain :PostUserPassword;
	rdfs:range xsd:string;
	msg:header "Authorization".

