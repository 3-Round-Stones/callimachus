<?xml version="1.0" encoding="UTF-8" ?>
<?xml-stylesheet type="text/xsl" href="/layout/template.xsl"?>
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:rdfs="http://www.w3.org/2000/01/rdf-schema#"
	xmlns:calli="http://callimachusproject.org/rdf/2009/framework#">
<head>
	<title about="?this">{rdfs:label}</title>
	<script>// <![CDATA[
		jQuery(function($){
			function onhashchange() {
				var path = location.pathname;
				if (location.hash) {
					path += location.hash;
				}
				$('#iframe')[0].src = '/callimachus/editor/editor.html#sparql!' + path;
			}
			$(window).bind('hashchange', onhashchange);
			onhashchange();
		});

		jQuery(function($){
			$('#form').submit(function(event) {
				event.preventDefault();
				$(window).bind('message', function(event) {
					if (event.originalEvent.source == $('#iframe')[0].contentWindow) {
						var msg = event.originalEvent.data;
						if (msg == 'OK\n\nPOST save') {
							location.replace('?view');
						}
					}
				});
				$('#iframe')[0].contentWindow.postMessage('POST save', '*');
				return false;
			});
			$('#saveas').click(function(event) {
				event.preventDefault();
				var name = prompt('Save as...', 'Untitled Query');
				if (name) {
					var local = encodeURI(name).replace(/%20/g,'-').toLowerCase();
					var header = 'POST create'
						+ '\nAction: /callimachus/NamedQuery?create'
						+ '\nLocation: ' + local + '.rq'
						+ '\nContent-Type: application/sparql-query';
					if ($('#cache').val()) {
						header += '\nCache-Control: ' + $('#cache').val();
					}
					$(window).bind('message', function(event) {
						if (event.originalEvent.source == $('#iframe')[0].contentWindow) {
							var msg = event.originalEvent.data;
							if (msg == 'OK\n\n' + header) {
								loadQuery('/query/' + local + '.rq?edit');
							}
						}
					});
					$('#iframe')[0].contentWindow.postMessage(header, '*');
				}
				return false;
			});
			function loadQuery(url) {
					$(window).bind('message', function(event) {
						if (event.originalEvent.source == $('#iframe')[0].contentWindow) {
							var msg = event.originalEvent.data;
							if (msg.indexOf('OK\n\nGET line.column\n\n') == 0) {
								location.href = url + '#' + msg.substring(msg.indexOf('\n\n', 4) + 2);
							}
						}
					});
				$('#iframe')[0].contentWindow.postMessage('GET line.column', '*');
			}
		});
	// ]]>
	</script>
</head>
<body>
	<form id="form" action="">
		<iframe id="iframe" class="auto-expand" src="/callimachus/editor/editor.html"> </iframe>
        <button type="submit">Save</button>
		<button id="saveas" type="button">Save as...</button>
		<button type="button" onclick="location.replace('?view')">Cancel</button>
		<button type="button" onclick="calli.deleteResource(form)">Delete</button>
	</form>
</body>
</html>

