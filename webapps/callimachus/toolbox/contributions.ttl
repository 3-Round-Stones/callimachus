@prefix xsd:<http://www.w3.org/2001/XMLSchema#>.
@prefix rdf:<http://www.w3.org/1999/02/22-rdf-syntax-ns#>.
@prefix rdfs:<http://www.w3.org/2000/01/rdf-schema#>.
@prefix owl:<http://www.w3.org/2002/07/owl#>.
@prefix skos:<http://www.w3.org/2004/02/skos/core#>.
@prefix msg:<http://www.openrdf.org/rdf/2011/messaging#>.
@prefix calli:<http://callimachusproject.org/rdf/2009/framework#>.
@prefix audit:<http://www.openrdf.org/rdf/2009/auditing#>.
@prefix :<#>.

<> a <../SchemaGraph>.

:GetContributions rdfs:subClassOf msg:Message;
	rdfs:subClassOf [owl:onProperty msg:target; owl:allValuesFrom <../User>];
	rdfs:subClassOf [owl:onProperty msg:object; owl:allValuesFrom <java:java.io.InputStream>];
	calli:method "GET";
	calli:query "contributions";
	calli:type "application/sparql-results+xml;q=0.1";
	calli:header "cache-control:no-store";
	calli:transform <../transforms/TransformIntoAtom>;
	calli:transform :TransformContributions;
	msg:sparql  """
		SELECT * {
			{
				$this rdfs:label ?title
				BIND (concat(str($this),"?contributions") as ?id)
				BIND ("feed" as ?type)
			} UNION {
				$this audit:revision [audit:committedOn ?updated]
				BIND (concat(str($this),"?contributions") as ?id)
				BIND ("feed" as ?type)
			} UNION {
				$this rdfs:label ?contributor_name
				BIND ($this as ?contributor_uri)
				BIND ("feed" as ?type)
			} UNION {
				{
					SELECT ?id (max(?title)  as ?title) (max(?updated) as ?updated) (max(?summary) as ?summary) (max(?icon) as ?icon)
							(?id as ?content_src) (max(?content_type) as ?content_type) ("entry" as ?type)
							(?id as ?link_edit_media_href) (concat(str(?id),"?view") as ?link_view_href) (concat(str(?id),"?history") as ?link_history_href)
							(concat(str(?revision),"?view") as ?link_href) (audit:revision as ?link_rel) ("text/html" as ?link_type) {
						?revision audit:contributor $this; audit:committedOn ?updated .
						?id audit:revision ?revision .
						OPTIONAL {
							?id skos:prefLabel ?title
						} OPTIONAL {
							?id foaf:name ?title
						} OPTIONAL {
							?id rdfs:label ?title
						} OPTIONAL {
							?id skosxl:literalForm ?title
						} OPTIONAL {
							?id dcterms:title ?title
						} OPTIONAL {
							?id rdfs:comment ?summary
						} OPTIONAL {
							?id a [calli:icon ?icon]
						} OPTIONAL {
							?id a [calli:type ?content_type]
						}
					} GROUP BY ?id ?revision ORDER BY desc(?updated) LIMIT 50
				}
				FILTER bound(?id)
			}
		} ORDER BY desc(?type) desc(?updated) ?id
	""".

:TransformContributions rdfs:subClassOf msg:Message;
	rdfs:subClassOf [owl:onProperty msg:target; owl:allValuesFrom <../User>];
	rdfs:subClassOf [owl:onProperty msg:object; owl:allValuesFrom <java:java.io.InputStream>];
	calli:type "application/xml";
	calli:transform <../transforms/TransformLayout>;
	msg:xslt <contributions.xsl>.

:inputStream a owl:ObjectProperty; a owl:FunctionalProperty;
	rdfs:domain :TransformContributions;
	rdfs:range <java:java.io.InputStream>;
	calli:type "application/sparql-results+xml".

