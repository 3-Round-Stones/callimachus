# 
#    Portions Copyright (c) 2009-10 Zepheira LLC, Some Rights Reserved
#    Portions Copyright (c) 2010-11 Talis Inc, Some Rights Reserved
# 
#    Licensed under the Apache License, Version 2.0 (the "License");
#    you may not use this file except in compliance with the License.
#    You may obtain a copy of the License at
# 
#        http://www.apache.org/licenses/LICENSE-2.0
# 
#    Unless required by applicable law or agreed to in writing, software
#    distributed under the License is distributed on an "AS IS" BASIS,
#    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#    See the License for the specific language governing permissions and
#    limitations under the License.

@prefix xsd:<http://www.w3.org/2001/XMLSchema#>.
@prefix rdf:<http://www.w3.org/1999/02/22-rdf-syntax-ns#>.
@prefix rdfs:<http://www.w3.org/2000/01/rdf-schema#>.
@prefix owl:<http://www.w3.org/2002/07/owl#>.
@prefix skos:<http://www.w3.org/2004/02/skos/core#>.
@prefix dc:<http://purl.org/dc/elements/1.1/>.
@prefix dcterms:<http://purl.org/dc/terms/>.
@prefix msg:<http://www.openrdf.org/rdf/2011/messaging#>.
@prefix calli:<http://callimachusproject.org/rdf/2009/framework#>.
@prefix :<#>.

:Delete rdfs:subClassOf msg:Message;
	rdfs:subClassOf [owl:onProperty msg:target; owl:allValuesFrom calli:Editable];
	rdfs:subClassOf [owl:onProperty msg:objectSet; owl:allValuesFrom owl:Nothing];
	msg:method "DELETE";
	msg:realm </accounts>;
	msg:imports <java:org.openrdf.model.BNode>;
	msg:imports <java:org.openrdf.model.URI>;
	msg:imports <java:javax.tools.FileObject>;
	msg:script """
		var con = this.objectConnection;
		var stmts = con.getStatements(null, null, this.resource, []);
		try {
			while (stmts.hasNext()) {
				var st = stmts.next();
				if (st.predicate.stringValue() != "http://www.w3.org/1999/02/22-rdf-syntax-ns#subject"
						&& st.predicate.stringValue() != "http://www.w3.org/1999/02/22-rdf-syntax-ns#object") {
					con.remove(st, []);
				}
			}
		} finally {
			stmts.close();
		}

		function removeTriples(subject) {
			var stmts = con.getStatements(subject, null, null, []);
			try {
				while (stmts.hasNext()) {
					var st = stmts.next();
					if (st.object instanceof BNode && !st.object.equals(subject)) {
						removeTriples(st.object);
					} else if (st.object instanceof URI && !st.object.equals(subject)) {
						var subj = subject.stringValue();
						var obj = st.object.stringValue();
						if (obj.indexOf(subj) == 0 && obj.charAt(subj.length) == "#") {
							removeTriples(st.object);
						} else {
							con.getObjectFactory().createObject(st.object).touchRevision();
						}
					}
					con.remove(st, []);
				}
			} finally {
				stmts.close();
			}
		}

		con.clear([this.resource]); //# clear graph
		removeTriples(this.resource); //# follow blank and hash references
		if (this instanceof FileObject) {
			this['delete'](); //# remove document
		}
	""".

:DeleteCreator owl:intersectionOf ( :Delete
		[owl:onProperty msg:target; owl:allValuesFrom [owl:intersectionOf (calli:Editable calli:Creator)]]);
	msg:imports <java:org.openrdf.http.object.exceptions.Conflict>;
	msg:script """
		if (this.HasCreatedChildren())
			throw new Conflict("Child resources of must be deleted first");
		return proceed();
	""".

:HasCreatedChildren rdfs:subClassOf msg:Message;
	rdfs:subClassOf [owl:onProperty msg:target; owl:allValuesFrom calli:Creator];
	rdfs:subClassOf [owl:onProperty msg:literal; owl:allValuesFrom xsd:boolean];
	rdfs:subClassOf [owl:onProperty msg:literal; owl:cardinality 1];
	msg:sparql """
		ASK {
			{
				$this a [calli:createRel ?rel].
				$this ?rel ?child
			} UNION {
				$this a [calli:createRev ?rev].
				?child ?rev $this
			}
		}
	""".

