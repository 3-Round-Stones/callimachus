@prefix xsd:<http://www.w3.org/2001/XMLSchema#>.
@prefix rdf:<http://www.w3.org/1999/02/22-rdf-syntax-ns#>.
@prefix rdfs:<http://www.w3.org/2000/01/rdf-schema#>.
@prefix owl:<http://www.w3.org/2002/07/owl#>.
@prefix skos:<http://www.w3.org/2004/02/skos/core#>.
@prefix msg:<http://www.openrdf.org/rdf/2011/messaging#>.
@prefix calli:<http://callimachusproject.org/rdf/2009/framework#>.
@prefix audit:<http://www.openrdf.org/rdf/2009/auditing#>.
@prefix :<#>.

:GetDiscussion rdfs:subClassOf msg:Message;
	rdfs:subClassOf [owl:onProperty msg:object; owl:allValuesFrom <java:java.io.InputStream>];
	msg:method "GET";
	msg:query "discussion";
	msg:type "application/sparql-results+xml";
	msg:transform :TransformDiscussion;
	msg:sparql  """
		SELECT REDUCED ?label ?note ?revision ?modified ?user ?name
		WHERE {
			{
				$this skos:prefLabel ?label
			} UNION {
				$this rdfs:label ?label
			} UNION {
				GRAPH ?revision { $this skos:editorialNote ?note }
				?revision audit:committedOn ?modified
				OPTIONAL { ?revision audit:contributor ?user
					OPTIONAL { ?user skos:prefLabel ?name }
					OPTIONAL { ?user rdfs:label ?name }
				}
			}
		}
		ORDER BY ?modified
	""".

:PostDiscussion rdfs:subClassOf msg:Message;
	rdfs:subClassOf [owl:onProperty msg:literal; owl:allValuesFrom xsd:string];
	msg:method "POST";
	msg:query "discussion";
	msg:realm </accounts>;
	msg:expect "303-see-other";
	msg:imports skos:editorialNote;
	msg:script """
		var vf = this.objectConnection.valueFactory;
		var lit = vf.createLiteral(form.get('note')[0]);
		this.objectConnection.add(this.resource, editorialNote.resource, lit, []);
		return this.resource + "?discussion";
	""".

:form a owl:ObjectProperty, owl:FunctionalProperty;
	rdfs:domain :PostDiscussion;
	rdfs:range <java:java.util.Map>;
	msg:type "application/x-www-form-urlencoded";.

:TransformDiscussion rdfs:subClassOf msg:Message;
	rdfs:subClassOf [owl:onProperty msg:object; owl:allValuesFrom <java:java.io.InputStream>];
	msg:type "application/xml";
	msg:transform <../layout.ttl#TransformLayout>;
	msg:xslt <discussion.xhtml>.

:inputStream a owl:ObjectProperty; a owl:FunctionalProperty;
	rdfs:domain :TransformDiscussion;
	rdfs:range <java:java.io.InputStream>;
	msg:type "application/sparql-results+xml".

