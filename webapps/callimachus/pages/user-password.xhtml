<?xml version="1.0" encoding="UTF-8" ?>
<?xml-stylesheet type="text/xsl" href="/callimachus/template.xsl"?>
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
    xmlns:rdfs="http://www.w3.org/2000/01/rdf-schema#"
    xmlns:calli="http://callimachusproject.org/rdf/2009/framework#"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema#"
    xmlns:foaf="http://xmlns.com/foaf/0.1/">
<head>
    <title about="?this">{rdfs:label}</title>
    <link type="text/css" href="/callimachus/styles/jquery.validate.password.css" rel="stylesheet" />
    <script type="text/javascript" src="/callimachus/scripts/jquery.validate.js">
    </script>
    <script type="text/javascript" src="/callimachus/scripts/jquery.validate.password.js">
    </script>
    <script type="text/javascript" src="/callimachus/scripts/md5.js">
    </script>
    <script type="text/javascript">//<![CDATA[
        jQuery(function($) {
            var uri = $('body').attr("about");
            var credential = calli.getUserIri();
            if (!$('#email').length) {
                $('#email-div').append('<input id="email" name="email" type="text" class="auto-expand email" />');
            }
            $("#form").validate({submitHandler: function(form) {
                var name = $("#name").text();
                var realm = $("#realm").text();
                var current = $("#current").val();
                var password = $("#password").val();
                if (current) {
                    current = hex_md5(name + ':' + realm + ':' + current);
                }
                if (password) {
                    password = hex_md5(name + ':' + realm + ':' + password);
                }
                   jQuery.ajax({type: 'POST', url: form.action,
                    data: {
                        email: $('#email').val(),
                        current: current,
                        password: password
                    },
                    success: function() {
                        if ($('#password').val() && credential && credential == uri) {
                            // need to log user out gracefully since they changed their password
                            $(document).trigger("calliLogout");
                        } else {
                            location = '?view';
                        }
                    }
                });
                return false;
               }});
        });
        // ]]>
    </script>
</head>
<body about="?this">
    <h1>Change password of <span property="rdfs:label" /></h1>
    <div id="sidebar">
        <aside>
            <p>Your e-mail address is used to reset your password</p>
        </aside>
        <aside>
            <h3>Choosing a good password</h3>
            <ul>
                <li>Never share your password to colleagues, friends, or family members, even when asked</li>
                <li>Don't choose passwords that relate to you as a person</li>
                <li>Don't use your last name, your spouse's name, the name of your pet, the date of birth, your favourite flower etc.</li>
                <li>Use complex multiple word pass phrases, never a single word</li>
            </ul>
        </aside>
    </div>
    <div style="display:none">
        <span id="name" property="calli:name" />
        <span rev="calli:hasComponent" resource="?space">
            <span rev="calli:authNamespace" resource="?digest">
                <span id="realm">{calli:authName}</span>
            </span>
        </span>
    </div>
    <form id="form" method="POST" action="?password" autocomplete="off">
        <label for="email">E-mail address</label>
        <div id="email-div">
            <input id="email" name="email" value="{calli:email}" type="email" class="auto-expand" />
        </div>
        <div class="hbox">
            <div>
                <label for="current">Current password</label>
                <input id="current" type="password" /><!-- not required if somebody else -->
            </div>
            <div>
                <label for="password">New password</label>
                <div>
                    <input id="password" type="password" password="#name" class="password" onkeyup="$(this).valid()" />
                    <div class="password-meter">
                        <label for="password" class="password-meter-message" />
                        <div class="password-meter-bg">
                            <div class="password-meter-bar"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <button id="save" type="submit">Save</button>
        <button id="cancel" type="button" onclick="location.replace('?view')">Cancel</button>
    </form>
</body>
</html>
