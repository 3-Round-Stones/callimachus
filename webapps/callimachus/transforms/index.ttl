@prefix xsd:<http://www.w3.org/2001/XMLSchema#>.
@prefix rdf:<http://www.w3.org/1999/02/22-rdf-syntax-ns#>.
@prefix rdfs:<http://www.w3.org/2000/01/rdf-schema#>.
@prefix owl:<http://www.w3.org/2002/07/owl#>.
@prefix skos:<http://www.w3.org/2004/02/skos/core#>.
@prefix msg:<http://www.openrdf.org/rdf/2011/messaging#>.
@prefix calli:<http://callimachusproject.org/rdf/2009/framework#>.
@prefix prov:<http://www.w3.org/ns/prov#>.
@prefix :<#>.

<> a <../SchemaGraph>.

<TransformIntoAtom> rdfs:subClassOf msg:Message;
    rdfs:subClassOf [owl:onProperty msg:target; owl:allValuesFrom <../Serviceable>];
   rdfs:subClassOf [owl:onProperty msg:object; owl:allValuesFrom <java:java.io.InputStream>];
   calli:type "application/atom+xml;q=0.5";
   calli:transform <TransformAtomLinks>;
   calli:xslt <sparql-results-atom.xsl>.

<TransformIntoAtom#sparqlResult> a owl:FunctionalProperty, owl:ObjectProperty;
   rdfs:domain <TransformIntoAtom>;
   rdfs:range <java:java.io.InputStream>;
   calli:type "application/sparql-results+xml".

<TransformAtomLinks> rdfs:subClassOf msg:Message;
    rdfs:subClassOf [owl:onProperty msg:target; owl:allValuesFrom <../Serviceable>];
   rdfs:subClassOf [owl:onProperty msg:object; owl:allValuesFrom <java:java.io.InputStream>];
   calli:type "application/atom+xml;q=0.5";
   calli:xslt <divert-atom-links.xsl>.

<TransformAtomLinks#xml> a owl:FunctionalProperty, owl:ObjectProperty;
   rdfs:domain <TransformAtomLinks>;
   rdfs:range <java:java.io.InputStream>;
   calli:type "application/atom+xml".


<TransformLayout> rdfs:subClassOf msg:Message;
    rdfs:subClassOf [owl:onProperty msg:target; owl:allValuesFrom <../Serviceable>];
    rdfs:subClassOf [owl:onProperty msg:object; owl:allValuesFrom <java:java.io.InputStream>];
    calli:type "application/xhtml+xml";
    calli:transform <TransformPage>;
    calli:xslt <../template.xsl>.

<TransformLayout#realm> a owl:ObjectProperty; a owl:FunctionalProperty;
    calli:transform <FindRealm>;
    rdfs:domain <TransformLayout>;
    rdfs:range <../Realm>.

<TransformLayout#xml> a owl:ObjectProperty; a owl:FunctionalProperty;
    calli:type "application/xhtml+xml";
    rdfs:domain <TransformLayout>;
    rdfs:range <java:java.io.InputStream>.

<FindRealm> rdfs:subClassOf msg:Message;
    rdfs:subClassOf [owl:onProperty msg:target; owl:allValuesFrom <../Serviceable>];
    rdfs:subClassOf [owl:onProperty msg:object; owl:allValuesFrom <../Realm>];
    calli:type "text/uri-list";
    msg:sparql """
        PREFIX calli:<http://callimachusproject.org/rdf/2009/framework#>
        SELECT ?realm {
            ?realm calli:hasComponent* $this
            FILTER EXISTS {?realm a calli:Realm}
        }
        ORDER BY desc(?realm) LIMIT 1
    """.


<TransformPage> rdfs:subClassOf msg:Message;
    rdfs:subClassOf [owl:onProperty msg:target; owl:allValuesFrom <../Serviceable>];
    rdfs:subClassOf [owl:onProperty msg:object; owl:allValuesFrom <java:java.io.InputStream>];
    calli:type "application/xhtml+xml";
    calli:transform <TransformXhtml>;
    calli:xslt <page.xsl>.

<TransformPage#query> a owl:DatatypeProperty; a owl:FunctionalProperty;
    rdfs:domain <TransformPage>;
    rdfs:range xsd:string;
    calli:query "*".

<TransformPage#xhtml> a owl:ObjectProperty; a owl:FunctionalProperty;
    calli:type "application/xhtml+xml";
    rdfs:domain <TransformPage>;
    rdfs:range <java:java.io.InputStream>.


<TransformXhtml> rdfs:subClassOf msg:Message;
    rdfs:subClassOf [owl:onProperty msg:target; owl:allValuesFrom <../Serviceable>];
    rdfs:subClassOf [owl:onProperty msg:object; owl:allValuesFrom <java:java.io.Reader>];
    calli:type "text/html";
    calli:xslt <xhtml-to-html.xsl>.

<TransformXhtml#xhtml> a owl:ObjectProperty; a owl:FunctionalProperty;
    calli:type "application/xhtml+xml";
    rdfs:domain <TransformXhtml>;
    rdfs:range <java:java.io.InputStream>.

# GET /callimachus/transforms/page-info?http://localhost:8080/main-article.docbook
:ResourceInfo rdfs:subClassOf msg:Message;
    rdfs:subClassOf [owl:onProperty msg:target; owl:hasValue <page-info>];
    rdfs:subClassOf [owl:onProperty msg:object; owl:allValuesFrom <java:java.io.InputStream>];
    calli:method "GET";
    calli:type "application/sparql-results+xml";
    calli:header "cache-control:no-store";
    msg:sparql  """
        PREFIX rdf:<http://www.w3.org/1999/02/22-rdf-syntax-ns#>
        PREFIX rdfs:<http://www.w3.org/2000/01/rdf-schema#>
        PREFIX skos:<http://www.w3.org/2004/02/skos/core#>
        PREFIX skosxl:<http://www.w3.org/2008/05/skos-xl#>
        PREFIX dc:<http://purl.org/dc/elements/1.1/>
        PREFIX dcterms:<http://purl.org/dc/terms/>
        PREFIX foaf:<http://xmlns.com/foaf/0.1/>
        PREFIX prov:<http://www.w3.org/ns/prov#>
        PREFIX calli:<http://callimachusproject.org/rdf/2009/framework#>
        SELECT DISTINCT ?updated ?iri ?label {
            {
                $resource prov:wasGeneratedBy [prov:endedAtTime ?updated]
            } UNION {
                ?iri calli:hasComponent* $resource
                OPTIONAL {
                    ?iri skos:prefLabel ?label
                } OPTIONAL {
                    ?iri foaf:name ?label
                } OPTIONAL {
                    ?iri rdfs:label ?label
                } OPTIONAL {
                    ?iri skosxl:literalForm ?label
                } OPTIONAL {
                    ?iri dcterms:title ?label
                }
            }
        } ORDER BY ?iri
    """.

:resource a owl:FunctionalProperty, owl:ObjectProperty;
    rdfs:domain :ResourceInfo;
    calli:query "*";
    calli:type "text/uri-list".

