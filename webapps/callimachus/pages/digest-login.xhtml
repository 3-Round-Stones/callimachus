<?xml version="1.0" encoding="UTF-8" ?>
<?xml-stylesheet type="text/xsl" href="/callimachus/template.xsl"?>
<html xmlns="http://www.w3.org/1999/xhtml"
        xmlns:xsd="http://www.w3.org/2001/XMLSchema#"
        xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
        xmlns:rdfs="http://www.w3.org/2000/01/rdf-schema#"
        xmlns:calli="http://callimachusproject.org/rdf/2009/framework#">
<head>
    <title resource="?this">{rdfs:label} Sign In</title>
    <script type="text/javascript" src="/callimachus/scripts/md5.js">
    </script>
    <script type="text/javascript">
    // <![CDATA[
    $(function(){
        $('#form').submit(function(event){
            var username = $("#username").val();
            var authName = $("#authName").text();
            var password = $("#password").val();
            var persistent = $('#persistent:checked').val();
            var options = {type: "POST", url: "?login",
                username: username,
                password: password,
                beforeSend: function(req){try{req.withCredentials=true;}catch(e){}},
                data: {persistent: persistent},
                success: function(doc) {
                    if (persistent && window.localStorage) {
                        var hash = hex_md5(username + ':' + authName + ':' + password);
                        var digestPassword = hex_md5(hash + ':' + doc);
                        localStorage.setItem("username", username);
                        localStorage.setItem("digestPassword", digestPassword);
                    }
                    $(document).trigger("calliLoggedIn");
                    var return_to = /&return_to=([^&]*)/.exec(window.location.search);
                    if (return_to && return_to[1]) {
                        window.location.replace(decodeURIComponent(return_to[1]));
                    } else {
                        window.location.replace('/');
                    }
                }
            };
            try {
                jQuery.ajax(options);
            } catch (e) {
                // Opera don't support spaces in ajax passwords
                if (options.password) {
                    delete options.password;
                    jQuery.ajax(options);
                }
            }
            event.preventDefault();
            return false;
        });
    });
    // ]]>
    </script>
</head>
<body resource="?this">
    <hgroup>
        <h1>{rdfs:label} Sign In</h1>
        <h2 id="authName">{calli:authName}</h2>
    </hgroup>
    <form id="form" method="POST" action="?login">
        <div class="control-group">
            <label class="control-label" for="username">Username or email</label>
            <div class="controls">
                <input type="text" id="username" placeholder="Username or email" required="required" autofocus="autofocus" />
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" for="password">Password</label>
            <div class="controls">
                <input type="password" id="password" placeholder="Password" />
            </div>
        </div>
        <div class="control-group">
            <div class="controls">
                <label class="checkbox">
                    <input type="checkbox" id="persistent" value="true" /> Stay signed in
                </label>
            </div>
        </div>
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Sign in</button>
            <a href="?daypass" class="btn">Need another password?</a>
        </div>
    </form>
</body>
</html>