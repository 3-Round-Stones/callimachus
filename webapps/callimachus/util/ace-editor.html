<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<title>Editor</title>
	<style type="text/css" media="screen">
	body {
		overflow: hidden;
		margin: 0px;
		padding: 0px;
	}
	#editor {
		margin: 0px;
		position: absolute;
		top: 0px;
		left: 0px;
		bottom: 0px;
		right: 0px;
	}
	</style>
	<script src="/callimachus/scripts/ace_bundle?source" type="text/javascript"></script>
	<script>
	window.onload = function() {
		var editor = ace.edit("editor");
		if (location.hash && location.hash.length > 1) {
			var hash = location.hash.substring(1);
			var Mode = require("ace/mode/" + hash).Mode;
			editor.getSession().setMode(new Mode());
		}
		editor.getSession().setUseWrapMode(true);
		var channel = new MessageChannel();
		channel.port1.onmessage = function handleMessage(event) {
			var msg = event.data;
			var header = msg;
			var body = null;
			if (msg.indexOf('\n') > 0) {
				header = msg.substring(0, msg.indexOf('\n'));
				body = msg.substring(msg.indexOf('\n') + 1);
			}
			if (header == 'GET text') {
				channel.port1.postMessage(header + '\n' + editor.getSession().getValue());
			} else if (header == 'POST text') {
				if (body != editor.getSession().getValue()) {
					var row = editor.getSelectionRange().start.row;
					editor.getSession().setValue(body);
					editor.gotoLine(row + 1);
				}
				channel.port1.postMessage(header);
			} else if (header == 'POST insert' && body) {
				editor.insert(body);
				channel.port1.postMessage(header);
			} else if (header == 'GET line.column') {
				var start = editor.getSelectionRange().start;
				channel.port1.postMessage(header + '\n' + (1 + start.row) + '.' + start.column);
			} else if (header == 'POST line.column' && body) {
				var line = parseInt(body.split('.', 2)[0]);
				var start = editor.getSelectionRange().start;
				if (start.row + 1 != line) {
					editor.gotoLine(line);
				}
				channel.port1.postMessage(header);
			}
		};
		channel.port1.start();
		parent.postMessage("calliEditorPort", [channel.port2], "*");
	};
	</script>
</head>
<body>
<pre id="editor"></pre>
</body>
</html>
